.. _chapter_upgrade_index:

固件升级
===================

固件下载地址
----------------

在资源下载页面中 :ref:`下载固件<chapter_download_firmware_index>`


固件升级教程
----------------

1. 安装USB驱动

    安装 :ref:`USB驱动<chapter_download_third_party_index>`，如果电脑可以识别设备，则可以不用安装

2. 连接设备

    将视觉传感器通过 Type-C USB 数据线连接至电脑

3. 配置信息

    打开 ``kflash_gui/`` 文件夹里的 ``kflash_gui.exe`` 应用程序，按照下图所示步骤进行操作。

    .. image:: images/sentry_upgrade_kflash_gui.png

4. 下载固件

    点击“下载”后将会出现下图所示界面，此时 **垂直压按视觉传感器的摇杆键约 2 秒** 来启动下载并等待下载完成.

    .. image:: images/sentry_upgrade_press_key.png
        :scale: 50 %

    .. image:: images/sentry_upgrade_kflash_download.png

5. 等待下载完成

    .. image:: images/sentry_upgrade_download_success.png

6. 重启传感器

    固件更新完成后传感器会自动重启,如果没有,可以短按 ``复位键`` 或者重新上电来重启设备。



固件更新说明
----------------

Version:V2.2.1 - 2022.07.20
***************************

**更新内容：**

1. 优化了色块BLOB在“准确模式“下的算法性能，相对于“灵敏模式“和”均衡模式”，该模式下色块输出的平滑性和稳定性有较大的改善，但此时只能同时检测一种颜色和一个色块结果，适合于特殊需求的应用
2. 改变算法参数时将立即生效，无需再执行”先关闭，再重启算法“的操作
3. Apriltag算法默认模式为36H11
4. 简单指令中增加了GET_ALL_VALUE指令，采用字符”A“或”a“，可以同时获取X、Y、W、H、L的数据结果，输出格式为：A+001+002+003+004+005,其中001为X坐标、002为Y坐标、003为W宽度、004为H高度、005为Label标签
5. 简单指令中增加了GET_IMAGE指令，采用字符”I“或”i“，可以获取当前的jpg图像，格式与图像帧相同
6. 修复了截图时，无法获取屏幕图片的问题，修复后，可以输出240x180的小图片，可以缓解ESP8285的内存压力，适合于云端识图的一些应用



Version:V2.1.5 - 2022.04.25
***************************

**更新内容：**

1. 线段算法增加模式选择，可以选择同时检测的线段数量，支持1～5个线段
2. 人脸算法增加口罩检测功能，当输出label=200时，表明戴有口罩
3. 人脸算法模型可存储的数据从原先的10个扩增为：消费版15个数据，企业版25个数据
4. 人脸算法现在支持通过指令进行人脸训练，写入参数寄存器（0x78&0x79）label=100(0x64)时可以训练该ID的人脸，label=0时删除人脸
5. 深度学习算法模型可存储的数据从原先的10个扩增为：消费版15个数据，企业版25个数据
6. 深度学习算法现在支持通过指令进行物体训练，写入参数寄存器（0x78&0x79）label=100(0x64)时可以开始训练该ID的物体，label=0时删除物体
7. 限定WiFi功能只能在“自定义”算法中启用
8. 图片传输和图片保存功能增加"RGB565"格式和"JPEG Base64"格式
9. 修复色块算法中缺少默认参数的问题
10. 修复UI界面下方提示框显示异常的问题
11. 将部分硬件设置相关的寄存器由读写属性变为只读属性，如UART和I2C的设置，波特率的设置等。不再允许通过软件方式来改变寄存器的设置，只可在UI界面中进行手动设置
12. 寄存器“自动保存”功能默认值改为0
13. 在UI界面中设置参数时，只有完全退出UI界面后才会进行保存，或者手动点击“寄存器”>“保存当前值”
14. 开机时向上拨动遥感10秒以上然后松开，可以恢复出厂设置，不再支持通过设置寄存器恢复出厂设置
15. [企业版]修复摄像头设置页面中，“曝光”项无法被正确设置的问题



Version:V2.1.3 - 2022.04.10
***************************

**更新内容：**

1. [企业版]修复了V2.1.2版本中UI界面中无法进入“移动物体”算法的问题
2. [企业版]修复了V2.1.2版本中进入和退出自定义算法中图像相关寄存器状态无法复位的问题



Version:V2.1.2 - 2022.04.06
***************************

**更新内容：**

1. 开放WiFi功能。Sentry2板载一颗ESP8285-WiFi芯片（内核与ESP8266相同，内置1M Flash版本），可以实现AIoT、MQTT、图传、云端识图、网络摄像头、WiFi遥控、WiFi透传等功能。此内容将加入开源计划，支持用户二次开发
2. 开放ESP8285-Arduino协处理器功能。Sentry2板载的ESP8285芯片可以作为Arduino控制器来使用，可通过Arduino-IDE进行代码编辑，完成WiFi功能开发，亦可加载Sentry驱动库，通过ESP8285控制算法开启和结果读取，无需外接主控也可以进行AI编程学习。通过USB端口可对ESP8266芯片进行程序烧录。
3. 开机时向下拨动摇杆按键可以进入烧录wifi固件模式，具体操作方法：下载ESP8266系列的Arduino开发板包，选择ESP8285，设置波特率为57600，复位模式为：no dtr（aka ck），下拨摇杆不要松开，然后点击烧录程序（此时会触发sentry重启以进入烧录模式），直至出现XX%的进度显示后可松开摇杆，等待程序烧录完成。
4. 新增[ID10]“Custom自定义”算法。支持用户在板载ESP8285芯片上运行自定义的算法：1、云端算法支持：Sentry2将摄像头图片通过WiFi送给第三方云端服务器进行识别，将返回的识别结果写入寄存器中；2、算法功能扩展：比如可以将小车巡线功能的完整逻辑代码转移到板载的ESP8285中去实现；3、算法性能提升：可以在ESP8285中对算法结果进行二次处理，比如滤波、消除抖动、阈值判断、数据统计、PID控制等。
5. 在“自定义”模式中，ESP8285可以读取摇杆按键的压按时的状态（Arduino-IO端口：0）
6. 支持用户对算法结果相关的寄存器数据写入功能，原先为只读状态，现为读写状态
7. 新增图像传输功能。可以将摄像头图像发送给WiFi芯片，也可以通过USB发送给电脑端，或通过UART发送给主控设备。此功能只能在“标准指令”模式下工作
8. 新增数据透传功能，支持WiFi至USB透传、WiFi至UART透传、USB至UART透传。透传数据、控制协议和图像数据可以同时支持。此功能只能在“标准指令”模式下工作
9. UI界面中新增寄存器配置选项，增加寄存器“自动保存”功能，开启后，当某参数改变会自动保存，如果关闭，设备重启后失效；增加“保存当前值“功能，在某些情况下，用户可以对当前寄存器参数进行手动保存；“恢复出厂值”功能，可以将设备参数复原至出厂状态。备注：在使用传感器过程中，如果Flash正在擦写数据时发生了断电或重启现象（比如与电机同时工作导致瞬间供电不足或意外断电），可能导致寄存器数值异常，此时可以尝试恢复出厂设置，代码中尽量不要使用硬件配置的功能，硬件配置可以在UI界面中操作
10. 优化了寄存器自动修复功能，当寄存器中的数值出现严重异常时，设备会自动重写寄存器
11. 简单指令中增加了调试模式，可以输入p1～p4来打印寄存器数据，数字1、2、3、4为日志等级，用于检查异常问题
12. UI界面中新增摄像头旋转功能，支持180度镜头旋转
13. 支持USB数据传输功能关闭，在USB的波特率设置中将其设为0即可
14. 坐标默认参数改为了百分比模式（相对值）
15. 修复了白平衡无法重复锁定的问题
16. 修复了Startup状态位在某些情况下的异常问题
17. [企业定制版]新增图片显示功能，可以在Sentry2的屏幕上显示用户图片
18. [企业定制版]新增图片保存功能，可以将用户图片保存至Flash中



Version: V1.3.7 - 2022.01.08
****************************

**更新内容：**

1. 修复了多次开启关闭二维码算法导致死机的问题
2. 修复了颜色识别算法配置中文界面描述错误的问题
3. 修复了中文界面部分字符无法显示的问题
4. 中国地区发货版本默认语言设为简体中文
5. 优化了20分类识别框的大小



Version: V1.3.6 - 2021.12.12
****************************

**更新内容：**

1. 深度学习算法优化更新，识别的连续性有所提升
2. 深度学习算法修复了模型保存失效的问题
3. 深度学习算法和人脸算法在“长按删除模型”时，增加了文字提示信息
4. 二维码算法修复了在百分比坐标模式下输出结果错误的问题
5. 一些已知bug问题处理



Version: V1.3.5 - 2021.12.07
****************************

**更新内容：**

      1. 深度学习算法优化更新，现在支持图案旋转后的识别
      2. 修改了颜色算法中对颜色阈值的判断区间，将青色的两端划分为蓝色或绿色范围，黑色和白色区间有所扩大
      3. 色块算法增加“同时可检测的最大色块的数量“选项，支持1～5个色块，当数值为1时，只返回1个检测结果
      4. 增加“坐标系”设置选项，现在用户可以选择使用“绝对值”或“百分比”坐标系，其中“绝对值”坐标系为图像的实际分辨率，水平方向0～320，垂直方向0～240，而百分比坐标系是量化后的值，水平和垂直的范围均是0～100，该数值表示目标物体相对于整个屏幕中的位置
      5. 处理器与摄像头性能提升与优化
      6. 一些已知bug问题处理



Version: V1.3.4 - 2021.11.25
****************************

**更新内容：**

1. 新的算法：深度学习，用户可以本地训练物体并进行识别，目前支持10个物体的存储。操作方法：

   (1) 开启深度学习算法，压按摇杆，屏幕中心会显示红色四角训练区域（四角型方框），此时有2秒左右的调整和对准时间，让被测物体位于方框内

   (2) 当绿色四角框转为绿色四边矩形框时，表明已训练完成

   (3) 可以在UI界面对已训练物体进行重命名或删除操作

   (4) 在运行界面长按摇杆2秒以上可以直接删除所有数据

2. Apriltag标签算法增加了25H9，36H11编码家族，可以在UI界面中进行设置，切换编码后需要重新打开算法才能生效

3. 色块、线条、Apriltag标签、20分类增加了算法性能选项，包含“灵敏、均衡、准确”三个选项，在UI界面中设置，设置后下次开启算法时生效

4. 增加了“简单协议指令”，串口可以通过字符方式来开启关闭算法，获取结果，可以在UI界面中设置。指令如下：

   格式为 “指令字符+ID数字+结束字符”

   其中结束字符可以为“空格”，“换行”，“回车”

   | 操作                  | 指令字符 | ID数字                          | 返回                          | 举例                      |
   | 开启算法              | O 或 o   | 算法编号                        | 1：成功<br />0：失败          | O7开启人脸识别            |
   | 关闭算法              | C 或 c   | 算法编号                        | 1：成功<br />0：失败          | C7关闭人脸识别            |
   | 查询检测结果数量      | N 或 n   | 算法编号                        | 检测到物体的数量，0为未检测到 | N7返回人脸数量            |
   | 获取水平x坐标         | X 或 x   | 检测结果的编号，可省略，默认为1 | 物体的水平x坐标值，0～319范围 | X1返回第1个人脸x坐标      |
   | 获取垂直y坐标         | Y 或 y   | 检测结果的编号，可省略，默认为1 | 物体的垂直y坐标值，0～239范围 | Y3返回第3个人脸y坐标      |
   | 获取物体w宽度         | W 或 w   | 检测结果的编号，可省略，默认为1 | 物体的宽度w值，0～319范围     | W返回第1个人脸宽度        |
   | 获取物体h高度         | H 或 h   | 检测结果的编号，可省略，默认为1 | 物体的高度h值，0～239范围     | H返回第1个人脸高度        |
   | 获取物体label分类标签 | L 或 l   | 检测结果的编号，可省略，默认为1 | 物体的分类标签label值         | L2返回第2个人脸的分类标签 |

   *线条和二维码算法含义略有不同，详见网络文档

   5. 颜色算法检测框增加了“未知颜色”的表示，采用“四角空心方框”表示，这些颜色一般为“青色”和“紫色”的色彩区间




Version: V1.3.2 - 2021.11.06
****************************

**更新内容：**

1. 中文界面正式版本发布，UI界面中支持语言选择，目前为英语和简体中文
2. 调整了UI界面中LED灯光的操作方式，取消下拉列表的形式，改为点按切换，取消手动模式复选框，改为当“检测到”和“未检测到”两个颜色相同时，自动切换为手动模式，即LED常亮



Version: V1.3.1 - 2021.11.01
****************************

---

**更新内容：**

1. 增加了中文界面（试行版本，仅UI界面支持中文）
2. 修改了20分类算法参数，降低误报
3. 修改了20分类算法中部分标签值的对应关系
4. 修复了人脸算法中UI设置界面选择错误的问题


Version: V1.2.11 - 2021.10.12
*****************************

**更新内容：**

1. 优化了屏幕显示效果



Version: V1.2.10 - 2021.09.03
*****************************

**更新内容：**

1. 优化了20分类算法，此固件需要配合新的算法



Version: V1.2.9 - 2021.09.01
****************************

**更新内容：**

1. 增加了开机画面
2. 线条检测采用了颜色标识，线条1～5分别用“红、黄、绿、蓝、紫”进行表示，增加了角度label的显示功能，更便于调试
3. 增加了强制解锁寄存器操作，当寄存器被上锁超过1秒后仍未解锁，将会强制解锁，避免产生死锁问题
4. 修复了二维码在某些情况下会在屏幕上显示多余字符的问题



Version: V1.2.8 - 2021.08.25
****************************

**更新内容：**

1. 现在可以支持多算法的并行处理，但是：Apriltag，Card，Face，20Class这4类算法同时只能开启1个，其余算法可以与之同时开启，开启算法越多，帧率会随之降低
2. 修复了V1.2.03版本中，在运行card算法时，打开UI界面死机的问题
3. 修复了人脸算法中，删除模型后Label编号出现异常或模型无法被删除的问题
4. 修复了设备启动时无法加载摄像头用户参数的问题
5. 修复了部分LCD屏幕的成像泛白的问题



Version: V1.2.3 - 2021.08.17
****************************

**更新内容：**

1. 板载USB接口现在可以与电脑进行通信，与串口操作相同，并增加UI设置界面
2. 优化了UI界面的按键操作灵敏度
3. Apriltag算法和QRCode算法增加了坐标线
4. 优化了Apriltag的检测结果，现在检测框的宽度w和高度h不再会因旋转而放大，检测距离更精准
5. 修复了Apriltag算法在面对单色物体时可能造成的死机问题
6. 修复了Card算法在锁定寄存器后无法通过协议读取结果的问题



Version: V1.2.1 - 2021.08.10
****************************

**更新内容：**

1. 新增算法：Apriltag（ID-3），可以检测识别16H5类型的编码图案，可以同时检测多个
2. 提升了人脸算法（Face）在训练模型时的处理速度
3. 提升了色块算法（Blob）的运行速度，解决大色块下处理速度慢的问题
4. 优化了系统架构，提升了处理器的运行速度与摄像头帧率
5. 白平衡锁定功能可以使用，锁定后可以解决色差变化的问题
6. UI界面增加了LED灯光的控制功能，可以设置颜色和亮度
7. UI界面增加了摄像头边缘锐化（Sharpness）调节功能，可以提升图像清晰度
8. UI界面增加了摄像头曝光值（Exposure）调节功能，可以提升强光下的成像问题
9. 运行界面增加当前zoom值状态
10. UI界面描述更新，显示内容更新，增加版本，日期，更换logo
11. 增加关闭算法的寄存器功能，用于替代恢复出厂设置，避免用户参数被改变
12. 修复了I2C模式数据通信异常的问题
13. 修复了串口协议参数设置的应答报文中缺失vision_id的问题
14. 修复了硬件设备恢复出厂设置导致通讯参数改变的问题
15. 修复了当算法结果为25个时无法正常处理的问题
16. 修复了UI界面与运行界面切换时导致显示异常的问题
17. 修复了UI界面显示值与设置值不符的问题
18. 修复了UI界面设置通讯方式时导致参数恢复为默认值的问题
